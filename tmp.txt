æˆ‘å·²ç»åŸºæœ¬å®Œæˆäº† Qt å®¢æˆ·ç«¯ä¸­ç§èŠåŠŸèƒ½çš„å¼€å‘ï¼Œç›®å‰ç¨‹åºèƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œç§èŠé€šä¿¡æµç•…ã€‚ä½† UI è¿˜æœ‰ä¸€äº›å°šå¾…å®Œå–„çš„å°é—®é¢˜ï¼Œä¸»è¦é›†ä¸­åœ¨æ ·å¼åº”ç”¨å’Œå¸ƒå±€äº¤äº’æ–¹é¢ã€‚æˆ‘å¸Œæœ›ä½ åœ¨ä¸æ›´æ”¹åŠŸèƒ½é€»è¾‘ã€ä¸æ›´åŠ¨ä»»ä½•æ¥å£çš„å‰æä¸‹ï¼ŒååŠ©æˆ‘ä¼˜åŒ–ä»¥ä¸‹å‡ ç‚¹ï¼š

ğŸ”§ ä»»åŠ¡ä¸€ï¼šPrivateChatTab å’Œ PrivateChatSession æ ·å¼æœªç”Ÿæ•ˆ

è¿™ä¸¤ä¸ªç»„ä»¶æœªæ­£ç¡®åº”ç”¨ QSS æ ·å¼è¡¨ã€‚ç»æ’æŸ¥ï¼Œæ˜¯ç”±äºå®ƒä»¬æ²¡æœ‰è®¾ç½®ä¸ QSS åŒ¹é…çš„å¯¹è±¡åç§°ï¼ˆobjectNameï¼‰ï¼Œå¯¼è‡´æ ·å¼é€‰æ‹©å™¨æ— æ³•ç”Ÿæ•ˆã€‚

è¯·å¸®åŠ©æˆ‘ä¿®æ”¹ç›¸åº”ç»„ä»¶çš„å¯¹è±¡åç§°è®¾ç½®é€»è¾‘ï¼Œæˆ–è°ƒæ•´ QSS ä¸­çš„é€‰æ‹©å™¨å†™æ³•ï¼Œä½¿å¾—æ ·å¼å¯ä»¥æ­£ç¡®åŒ¹é…å¹¶ç”Ÿæ•ˆã€‚

æ³¨æ„ä¸è¦å½±å“å·²æœ‰çš„ QSS æ ·å¼å®šä¹‰ï¼Œä»…å¯¹å½“å‰ä¸¤ä¸ªç±»è¿›è¡Œæ ·å¼ä¿®å¤ã€‚

æ³¨æ„qssæ ·å¼çš„è¯­æ³•é—®é¢˜,å‚è€ƒåŸæœ‰qssæ–‡ä»¶,ä»…ä»…ä½¿ç”¨ç®€å•çš„css2è¯­æ³•,ä¸è¦åµŒå¥—

ğŸ”§ ä»»åŠ¡äºŒï¼šç”¨æˆ·åˆ—è¡¨ï¼ˆç”¨æˆ·é€‰æ‹©åŒºåŸŸï¼‰çš„ UI äº¤äº’é€»è¾‘è¾ƒä¸ºç”Ÿç¡¬

å½“å‰ç”¨æˆ·åˆ—è¡¨ç‚¹å‡»ã€é€‰æ‹©ç­‰äº¤äº’é€»è¾‘ä¸å¤Ÿæµç•…ï¼ŒUI ä½“éªŒç•¥æ˜¾åƒµç¡¬ã€‚

è¯·ä¼˜åŒ–è¯¥åŒºåŸŸçš„äº¤äº’è¡Œä¸ºï¼Œä½¿å…¶æ›´è‡ªç„¶ã€‚

æ­¤å¤–ï¼Œè¯¥åŒºåŸŸåœ¨ç”¨æˆ·æ•°è¾ƒå¤šæ—¶æœªå¯ç”¨æ»šåŠ¨æ¡ï¼Œå¯¼è‡´åˆ—è¡¨æº¢å‡ºã€‚

è¯·æ·»åŠ æ»šåŠ¨æ¡å¹¶ç¡®ä¿å…¶ä¸å½“å‰ QSS æ ·å¼å…¼å®¹å¹¶æ­£ç¡®åŠ è½½ã€‚

ä¿è¯ç°æœ‰æ ·å¼åœ¨ç”¨æˆ·åˆ—è¡¨ä¸­èƒ½æ­£ç¡®æ¸²æŸ“ï¼Œé¿å…æ ·å¼è¢«é®æŒ¡æˆ–æœªåº”ç”¨ã€‚

ğŸ”§ ä»»åŠ¡ä¸‰ï¼šä¼šè¯åˆ—è¡¨æ ‡ç­¾ï¼ˆtabï¼‰å¸ƒå±€ä¼˜åŒ–

å½“å‰ä¼šè¯åˆ—è¡¨æ ‡ç­¾ä½äºå·¦ä¸Šè§’ï¼Œæ˜¾ç¤ºé€»è¾‘ä¸åˆç†ï¼Œå»ºè®®å°†å…¶ç§»åŠ¨åˆ°ç•Œé¢å·¦ä¾§ï¼Œä»¥ä¾§è¾¹æ ï¼ˆsidebarï¼‰çš„å½¢å¼å‘ˆç°ã€‚

è¯¥åŒºåŸŸå½“å‰æ˜¾ç¤ºçš„æ˜¯ç”¨æˆ·çš„ usernameï¼Œåº”å½“æ˜¾ç¤ºå¯¹åº”çš„ nicknameã€‚

åŒæ ·ï¼Œè¯¥åŒºåŸŸåœ¨ä¼šè¯è¾ƒå¤šæ—¶ä¹Ÿåº”å…·å¤‡æ»šåŠ¨æ¡æ”¯æŒã€‚

éœ€è¦åŠ è½½æˆåŠŸå¹¶åº”ç”¨ QSS æ ·å¼ï¼Œä¸”ä¸å½±å“å…¶ä»–éƒ¨åˆ†æ ·å¼é€»è¾‘ã€‚

ğŸ“ è¦æ±‚æ€»ç»“ï¼š

è¯·ä¿®æ”¹å¸ƒå±€ä»£ç ï¼Œä½¿ sidebar æ˜¾ç¤ºåœ¨å·¦ä¾§ï¼Œå¹¶ä¸ºå…¶æ·»åŠ æ»šåŠ¨åŒºåŸŸï¼›

è¯·è®¾ç½®æ‰€æœ‰ç›¸å…³ç»„ä»¶çš„ objectNameï¼Œå¹¶ç¡®ä¿ QSS é€‰æ‹©å™¨èƒ½æ­£ç¡®åŒ¹é…ï¼›

ä¸è¦ä¿®æ”¹æ¥å£ã€ä¸šåŠ¡é€»è¾‘åŠåŠŸèƒ½å®ç°ï¼Œåªåš UI å±‚å’Œæ ·å¼å±‚ç›¸å…³ä¼˜åŒ–ï¼›

ä¸è¦æ”¹åŠ¨é¡¹ç›®ä¸­å·²æœ‰çš„ QSS æ ·å¼å®šä¹‰ï¼Œåªåšå¿…è¦çš„æ ·å¼è¡¥å……å’Œå¯¹è±¡å‘½åè°ƒæ•´ï¼›

ä¿è¯ä¿®æ”¹åé¡¹ç›®ä¾ç„¶èƒ½å¤Ÿæµç•…è¿è¡Œã€‚

ä»¥ä¸‹æ˜¯ç›¸å…³çš„cppä»£ç å’Œqss:
#include "PrivateChatTab.h"
#include <QDateTime>
#include <QHBoxLayout>
#include <QLabel>
#include <QMessageBox>
#include <QScrollBar>
#include <QtConcurrent/QtConcurrent>
#include <QDebug.h>

PrivateChatTab::PrivateChatTab(ChatClient* client, const QString& username, const QString& nickname,
                               QWidget* parent)
    : QWidget(parent), chatClient(client), curUsername(username), curNickname(nickname)
{
    setupUi();
    connectSignals();
}

void PrivateChatTab::setupUi()
{
    QVBoxLayout* privateTabLayout = new QVBoxLayout(this);
    privateTabLayout->setContentsMargins(8, 8, 8, 8);
    privateTabLayout->setSpacing(10);

    QSplitter* privateSplitter = new QSplitter(Qt::Horizontal);
    privateSplitter->setObjectName("privateSplitter");

    QWidget* chatWidget = new QWidget();
    QVBoxLayout* privateChatLayout = new QVBoxLayout(chatWidget);
    privateChatLayout->setContentsMargins(0, 0, 0, 0);
    chatSessions = new QTabWidget();
    chatSessions->setObjectName("chatSessions");
    chatSessions->setTabsClosable(false);
    privateChatLayout->addWidget(chatSessions);

    QWidget* usersWidget = new QWidget();
    QVBoxLayout* usersLayout = new QVBoxLayout(usersWidget);
    usersLayout->setContentsMargins(0, 0, 0, 0);

    // åœ¨çº¿
    QLabel* usersLabel = new QLabel("åœ¨çº¿ç”¨æˆ·");
    usersLabel->setObjectName("usersLabel");
    onlineUsersList = new QListWidget();
    onlineUsersList->setObjectName("onlineUsersList");
    onlineUsersList->setMaximumWidth(200);
    usersLayout->addWidget(usersLabel);
    usersLayout->addWidget(onlineUsersList);

    // ç¦»çº¿
    QLabel* offlineUsersLabel = new QLabel("ç¦»çº¿ç”¨æˆ·");
    offlineUsersLabel->setObjectName("offlineUsersLabel");
    offlineUsersList = new QListWidget();
    offlineUsersList->setObjectName("offlineUsersList");
    offlineUsersList->setMaximumWidth(200);
    usersLayout->addWidget(offlineUsersLabel);
    usersLayout->addWidget(offlineUsersList);

    privateSplitter->addWidget(chatWidget);
    privateSplitter->addWidget(usersWidget);
    privateSplitter->setSizes({800, 200});
    privateTabLayout->addWidget(privateSplitter);
}

void PrivateChatTab::connectSignals()
{
    // ç‚¹å‡»å°±åˆ›å»ºæˆ–è€…åˆ‡æ¢åˆ°ç›®æ ‡ä¼šè¯
    connect(onlineUsersList, &QListWidget::itemClicked, this, &PrivateChatTab::handleUserSelected);
    connect(offlineUsersList, &QListWidget::itemClicked, this, &PrivateChatTab::handleUserSelected);
}

void PrivateChatTab::handleUserSelected(QListWidgetItem* item)
{
    if (!item) return;
    QString targetUser = item->data(Qt::UserRole).toString();
    qDebug() << "é€‰ä¸­ user: " << targetUser;
    PrivateChatSession* session = getOrCreateSession(targetUser);
    // æ­¤å¤„åªéœ€è¦ä¸€ä¸ªå‚æ•°
    chatSessions->setCurrentWidget(session);
}

PrivateChatSession* PrivateChatTab::getOrCreateSession(const QString& targetUser)
{
    if (sessions.contains(targetUser))
    {
        return sessions[targetUser];
    }
    // QString targetUsername = allUsers[targetUser]["username"].toString();
    // targetUserå·²ç»è¡¨ç¤ºusernameäº†
    QString targetNickname = allUsers[targetUser]["nickname"].toString();

    PrivateChatSession* session = new PrivateChatSession(chatClient, curUsername, curNickname,
                                                         targetUser, targetNickname, this);
    sessions[targetUser] = session;
    int index = chatSessions->addTab(session, targetUser);
    chatSessions->setTabToolTip(index, QString("Chat with %1").arg(targetUser));

    // Connect session signals to ChatClient
    connect(session, &PrivateChatSession::sendMessageRequested, this,
            [=](const QString& target, const QString& content)
            { chatClient->sendPrivateMessage(target, content); });

    connect(session, &PrivateChatSession::sendFileRequested, this,
            [=](const QString& target, const QByteArray& content)
            { chatClient->sendFile(target, content); });
    // qDebug() << "å‘é€å¯¹è±¡user: " << targetUser;

    return session;
}

PrivateChatSession* PrivateChatTab::getOrCreateSessionTwo(const QString& sender,
                                                          const QString& receiver)
{
    QString targetUser;
    if (sender == curUsername)
        targetUser = receiver;
    else
        targetUser = sender;
    return getOrCreateSession(targetUser);
}

void PrivateChatTab::appendMessage(const QString& sender, const QString& receiver,
                                   const QString& content, const QString& timestamp)
{  // senderè¡¨ç¤ºusernameè€Œä¸æ˜¯nickname!!!
    qDebug() << "sender: " << sender << "receiver: " << receiver << " content: " << content;
    PrivateChatSession* session = getOrCreateSessionTwo(sender, receiver);
    session->appendMessage(sender, receiver, content, timestamp);
    // è¿™é‡Œä¹Ÿéœ€è¦ä¿®æ”¹receiver
}

void PrivateChatTab::handleFileReceived(const QString& sender, const QString& receiver,
                                        const QByteArray& fileContent, const QString& timestamp)
{
    PrivateChatSession* session = getOrCreateSessionTwo(sender, receiver);
    session->handleFileReceived(sender, receiver, fileContent, timestamp);
}

// æŠŠæ¶‰åŠonlinelist, offlinelistçš„é€»è¾‘å…¨éƒ¨æå–å‡ºæ¥, å•ç‹¬å¤„ç†
void PrivateChatTab::addToOnlineList(const QJsonObject& userObj)
{
    QString username = userObj["username"].toString();
    QString nickname = userObj["nickname"].toString();
    QString displayText = QString("%1 (%2)").arg(nickname).arg(username);
    QListWidgetItem* item = new QListWidgetItem(displayText);
    item->setData(Qt::UserRole, username);
    qDebug() << "add online users: " << item << " data: " << item->data(Qt::UserRole).toString();
    onlineUsersList->addItem(item);
}

void PrivateChatTab::removeFromOnlineList(const QJsonObject& userObj)
{
    if (!userObj.contains("username"))
    {
        qDebug() << "removeFromOnlineList: Missing username in userObj";
        return;
    }

    QString username = userObj["username"].toString();
    for (int i = 0; i < onlineUsersList->count(); ++i)
    {
        QListWidgetItem* item = onlineUsersList->item(i);
        if (item->data(Qt::UserRole).toString() == username)
        {
            qDebug() << "Removing from online users: " << username;
            delete onlineUsersList->takeItem(i);
            break;
        }
    }
}

void PrivateChatTab::addToOfflineList(const QJsonObject& userObj)
{
    QString username = userObj["username"].toString();
    QString nickname = userObj["nickname"].toString();
    QString displayText = QString("%1 (%2)").arg(nickname).arg(username);
    QListWidgetItem* item = new QListWidgetItem(displayText);
    item->setData(Qt::UserRole, username);
    qDebug() << "add offline users: " << item << " data: " << item->data(Qt::UserRole).toString();
    offlineUsersList->addItem(item);
}

void PrivateChatTab::removeFromOfflineList(const QJsonObject& userObj)
{
    if (!userObj.contains("username"))
    {
        qDebug() << "removeFromOfflineList: Missing username in userObj";
        return;
    }

    QString username = userObj["username"].toString();
    for (int i = 0; i < offlineUsersList->count(); ++i)
    {
        QListWidgetItem* item = offlineUsersList->item(i);
        if (item->data(Qt::UserRole).toString() == username)
        {
            qDebug() << "Removing from offline users: " << username;
            delete offlineUsersList->takeItem(i);
            break;
        }
    }
}

void PrivateChatTab::initOnlineUsers(const QJsonArray& users)  // åˆå§‹åŒ–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
{
    onlineUsersList->clear();
    for (const QJsonValue& user : users)
    {
        QJsonObject userObj = user.toObject();
        addToOnlineList(userObj);
        userObj["isOnline"] = true;
        allUsers[userObj["username"].toString()] = userObj;
        onlineNumbers++;
    }
}

void PrivateChatTab::initOfflineUsers(const QJsonArray& users)  // åˆå§‹åŒ–ç¦»çº¿ç”¨æˆ·åˆ—è¡¨
{
    offlineUsersList->clear();
    for (const QJsonValue& user : users)
    {
        QJsonObject userObj = user.toObject();
        addToOfflineList(userObj);
        userObj["isOnline"] = false;
        allUsers[userObj["username"].toString()] = userObj;
        offlineNumbers++;
    }
}
// å‘ç°ä¸€ä¸ªé‡å¤§é—®é¢˜: å‘é€userç±»æ¯”åªå‘é€usernameæ›´åˆé€‚,å› ä¸ºusernameæ— æ³•å­˜å‚¨
// å·²ç»è§£å†³, 0è¡¨ç¤ºç™»å½•
void PrivateChatTab::someoneChange(int status, const QJsonObject& cur_user)
{
    if (status == 0)  // ä¸Šçº¿
    {
        QString cur_username = cur_user["username"].toString();
        if (allUsers.contains(cur_username))
        {
            if (!allUsers[cur_username]["isOnline"].toBool())  // å–å‡ºéƒ½è¦å†™å¥½å¤š
            {
                allUsers[cur_username]["isOnline"] = true;
                onlineNumbers++;
                offlineNumbers--;
                qDebug() << cur_username << " ä¸Šçº¿";
                addToOnlineList(cur_user);
                removeFromOfflineList(cur_user);
            }
            else
            {
                qDebug() << cur_username << " é‡å¤ç™»å½•";
            }
        }
        else
        {
            allUsers[cur_username] = cur_user;
            allUsers[cur_username]["isOnline"] = true;
            onlineNumbers++;
            qDebug() << cur_username << " æ–°å¢åœ¨çº¿";
            addToOnlineList(cur_user);
        }
    }
    else  // ä¸‹çº¿
    {
        QString cur_username = cur_user["username"].toString();
        if (allUsers.contains(cur_username))
        {
            if (allUsers[cur_username]["isOnline"].toBool())  // å½“å‰åœ¨çº¿
            {
                allUsers[cur_username]["isOnline"] = false;
                onlineNumbers--;
                offlineNumbers++;
                addToOfflineList(cur_user);
                removeFromOnlineList(cur_user);
            }
            else
            {
                qDebug() << cur_username << " é‡å¤ç™»å‡º";
            }
        }
        else
        {
            allUsers[cur_username] = cur_user;
            allUsers[cur_username]["isOnline"] = false;
            offlineNumbers++;
            qDebug() << cur_username << " æ–°å¢ç¦»çº¿";
            addToOfflineList(cur_user);
        }
    }
}

int PrivateChatTab::getOnlineNumber()
{
    return onlineNumbers;
}
int PrivateChatTab::getOfflineNumber()
{
    return offlineNumbers;
}


#include "PrivateChatSession.h"
#include <QDateTime>
#include <QHBoxLayout>
#include <QMessageBox>
#include <QScrollBar>
#include <QtConcurrent/QtConcurrent>

PrivateChatSession::PrivateChatSession(ChatClient* client, const QString& curUsername_,
                                       const QString& curNickname_, const QString& targetUsername_,
                                       const QString& targetNickname_, QWidget* parent)
    : QWidget(parent),
      chatClient(client),
      curUsername(curUsername_),
      curNickname(curNickname_),
      targetUsername(targetUsername_),
      targetNickname(targetNickname_)
{
    setupUi();
    connectSignals();
}

void PrivateChatSession::setupUi()
{
    QVBoxLayout* layout = new QVBoxLayout(this);
    layout->setContentsMargins(8, 8, 8, 8);
    layout->setSpacing(10);

    privateChatDisplay = new QScrollArea();
    privateChatDisplay->setObjectName("privateChatDisplay_" + targetUsername);
    privateChatDisplay->setMinimumHeight(400);
    privateChatDisplay->setMinimumWidth(600);
    privateChatContainer = new QWidget();
    privateChatContainer->setObjectName("privateChatContainer_" + targetUsername);
    QVBoxLayout* messagesLayout = new QVBoxLayout(privateChatContainer);
    messagesLayout->setAlignment(Qt::AlignTop);
    messagesLayout->setContentsMargins(0, 0, 0, 0);
    privateChatDisplay->setWidget(privateChatContainer);
    privateChatDisplay->setWidgetResizable(true);

    QHBoxLayout* inputLayout = new QHBoxLayout();
    privateMessageInput = new QLineEdit();
    privateMessageInput->setObjectName("privateMessageInput_" + targetUsername);
    privateMessageInput->setPlaceholderText("è¾“å…¥ç§èŠæ¶ˆæ¯...");
    privateSendButton = new QPushButton("å‘é€");
    privateSendButton->setObjectName("privateSendButton_" + targetUsername);
    sendFileButton = new QPushButton("æ–‡ä»¶");
    sendFileButton->setObjectName("sendFileButton_" + targetUsername);
    inputLayout->addWidget(privateMessageInput);
    inputLayout->addWidget(privateSendButton);
    inputLayout->addWidget(sendFileButton);

    layout->addWidget(privateChatDisplay);
    layout->addLayout(inputLayout);
}

void PrivateChatSession::connectSignals()
{
    connect(privateSendButton, &QPushButton::clicked, this,
            &PrivateChatSession::sendPrivateMessage);
    connect(privateMessageInput, &QLineEdit::returnPressed, this,
            &PrivateChatSession::sendPrivateMessage);
    connect(sendFileButton, &QPushButton::clicked, this, &PrivateChatSession::sendFile);
}

void PrivateChatSession::sendPrivateMessage()
{
    QString content = privateMessageInput->text().trimmed();
    if (content.isEmpty()) return;
    if (content.toUtf8().size() > 1000)
    {
        QMessageBox::warning(this, "é”™è¯¯", "æ¶ˆæ¯å†…å®¹ä¸èƒ½è¶…è¿‡1000å­—èŠ‚");
        return;
    }
    qDebug() << "Sending message to: " << targetUsername << ": " << content;
    emit sendMessageRequested(targetUsername, content);
    QString timestamp = QDateTime::currentDateTime().toString("hh:mm:ss");
    appendMessage(curUsername, targetUsername, content, timestamp);
    privateMessageInput->clear();
}

void PrivateChatSession::sendFile()
{
    QString filePath = QFileDialog::getOpenFileName(this, "é€‰æ‹©æ–‡ä»¶");
    if (filePath.isEmpty()) return;
    QFile file(filePath);
    if (!file.open(QIODevice::ReadOnly))
    {
        QMessageBox::warning(this, "é”™è¯¯", "æ— æ³•æ‰“å¼€æ–‡ä»¶");
        return;
    }
    qint64 size = file.size();
    if (size > 10 * 1024 * 1024)
    {
        QMessageBox::warning(this, "é”™è¯¯", "æ–‡ä»¶ä¸èƒ½è¶…è¿‡10MB");
        file.close();
        return;
    }
    QByteArray fileContent = file.readAll();
    emit sendFileRequested(targetUsername, fileContent);
    QString timestamp = QDateTime::currentDateTime().toString("hh:mm:ss");
    appendMessage(curUsername, targetUsername, "[å‘é€æ–‡ä»¶] " + QFileInfo(filePath).fileName(),
                  timestamp);
    file.close();
}

void PrivateChatSession::appendMessage(const QString& sender, const QString& receiver,
                                       const QString& content, const QString& timestamp)
{
    QVBoxLayout* layout = qobject_cast<QVBoxLayout*>(privateChatContainer->layout());
    if (!layout)
    {
        qDebug() << "PrivateChatSession: Invalid container layout for" << targetUsername;
        return;
    }

    if (layout->count() > 0)
    {
        QLayoutItem* item = layout->itemAt(layout->count() - 1);
        if (item->spacerItem())
        {
            layout->removeItem(item);
            delete item;
        }
    }

    // è½¬æ¢ä¸ºæ˜¾ç¤ºç”¨çš„ nickname
    QString displaySender = sender;
    if (sender == curUsername)
        displaySender = curNickname;
    else if (sender == targetUsername)
        displaySender = targetNickname;

    qDebug() << "Appending message: sender=" << sender << ", displaySender=" << displaySender
             << ", content=" << content;

    MessageBubble* bubble = new MessageBubble("", displaySender, content, timestamp,
                                              sender == curUsername, privateChatContainer);
    layout->addWidget(bubble);
    layout->addStretch();

    bool isAtBottom = privateChatDisplay->verticalScrollBar()->value() >=
                      privateChatDisplay->verticalScrollBar()->maximum() - 20;
    privateChatDisplay->viewport()->update();
    if (isAtBottom)
    {
        QTimer::singleShot(10, privateChatDisplay,
                           [=]()
                           {
                               privateChatDisplay->verticalScrollBar()->setValue(
                                   privateChatDisplay->verticalScrollBar()->maximum());
                           });
    }
}

void PrivateChatSession::handleFileReceived(const QString& sender, const QString& receiver,
                                            const QByteArray& fileContent, const QString& timestamp)
{
    QString saveFilePath = QFileDialog::getSaveFileName(this, "ä¿å­˜æ–‡ä»¶");
    if (saveFilePath.isEmpty()) return;
    QFuture<void> future = QtConcurrent::run(
        [=]()
        {
            QFile file(saveFilePath);
            if (file.open(QIODevice::WriteOnly))
            {
                file.write(fileContent);
                file.close();
                QMetaObject::invokeMethod(
                    this,
                    [=]()
                    {
                        appendMessage(sender, receiver,
                                      "[æ¥æ”¶æ–‡ä»¶] " + QFileInfo(saveFilePath).fileName(),
                                      timestamp);
                    });
            }
            else
            {
                qDebug() << "Failed to save file:" << saveFilePath;
            }
        });
    Q_UNUSED(future);
}
/* Global Styles */
* {
    font-family: "Segoe UI", "Microsoft YaHei", "Noto Sans", sans-serif;
    font-size: 14px;
}

/* Login and Register Windows */
#LoginWindow, #RegisterWindow {
    background: transparent;
}

QWidget#centralWidget {
    background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #FFD1E1, stop:1 #E1D1FF);
    border-radius: 12px;
    padding: 20px;
}

/* Input Fields */
#usernameEdit, #passwordEdit, #nicknameEdit {
    padding: 12px;
    border: 2px solid #FFE4EC;
    border-radius: 8px;
    background-color: #FFFFFF;
    font-size: 14px;
    margin: 8px 0;
}

#usernameEdit:focus, #passwordEdit:focus, #nicknameEdit:focus {
    border-color: #F06292;
    background-color: #FFF5F8;
    outline: none;
}

/* Buttons */
#loginButton, #registerButton, #backToLoginButton {
    padding: 12px 30px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    background: #5782df;
    color: #FFFFFF;
    border: none;
    min-width: 120px;
}

#loginButton:hover, #registerButton:hover, #backToLoginButton:hover {
    background: #B196FF;
}

/* Status Label */
#statusLabel {
    color: #7B61FF;
    font-size: 13px;
    padding: 8px;
}

/* Chat Window */
#ChatWindow {
    background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #FFF5F8, stop:1 #F5F0FF);
}

/* Tab Widget */
QTabWidget {
    background: #FFFFFF;
    border-radius: 10px;
}

#chatTabs::pane {
    border: 1px solid #FFE4EC;
    background-color: #FFFFFF;
    border-radius: 10px;
}

QTabBar::tab {
    background: #FFE4EC;
    padding: 14px 30px;
    border: 1px solid #FFB1C8;
    border-bottom: none;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    margin-right: 6px;
    font-size: 14px;
    color: #7B61FF;
}

QTabBar::tab:selected {
    background: #FFFFFF;
    color: #F06292;
    font-weight: bold;
    border-bottom: 3px solid #F06292;
}

QTabBar::tab:hover {
    background: #FFF0F5;
}

/* Chat Containers */
#publicChatContainer, #privateChatContainer, #groupChatContainer {
    background: #FFFFFF;
    border-radius: 12px;
    padding: 10px;
}

/* Scroll Areas */
#publicChatDisplay, #privateChatDisplay, #groupChatDisplay {
    border: none;
    background: transparent;
    margin: 0;
}

QScrollArea {
    border: none;
    background-color: transparent;
}

QScrollArea > QWidget > QWidget {
    background-color: transparent;
}

/* Input Fields */
#publicMessageInput, #privateMessageInput, #groupMessageInput {
    padding: 12px;
    border: 1px solid #FFE4EC;
    border-radius: 8px;
    background: #FFF5F8;
    font-size: 14px;
}

#publicMessageInput:focus, #privateMessageInput:focus, #groupMessageInput:focus {
    border-color: #F06292;
}

/* Buttons */
#publicSendButton, #privateSendButton, #groupSendButton, #sendFileButton {
    padding: 12px 20px;
    border-radius: 8px;
    background: #5782df;
    color: #FFFFFF;
    font-weight: 600;
    border: none;
    min-width: 80px;
}

#publicSendButton:hover, #privateSendButton:hover, #groupSendButton:hover, #sendFileButton:hover {
    background: #B196FF;
}

/* Splitter */
#privateSplitter {
    background: #FFF5F8;
}

QSplitter::handle:horizontal {
    width: 6px;
    background: #FFB1C8;
}

/* Online Users List */
#onlineUsersList {
    border: 1px solid #FFE4EC;
    border-radius: 10px;
    background: #FFFFFF;
    padding: 10px;
}

#onlineUsersList::item {
    padding: 12px;
    border-radius: 6px;
    margin: 6px;
}

#onlineUsersList::item:selected {
    background: #F06292;
    color: #FFFFFF;
}

#onlineUsersList::item:hover {
    background: #FFF0F5;
}

/* Group Combo */
#groupCombo {
    padding: 12px;
    border: 1px solid #FFE4EC;
    border-radius: 8px;
    background: #FFF5F8;
    font-size: 14px;
}

#groupCombo:focus {
    border-color: #F06292;
}

/* Status Bar */
QStatusBar {
    background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 #FFB1C8, stop:1 #C8B1FF);
    border-top: 1px solid #FFE4EC;
    padding: 10px;
}

#statusLabel, #onlineCountLabel {
    color: #7B61FF;
    font-weight: 600;
    padding: 6px 15px;
}

#logoutButton {
    background: #FF6F91;
    color: #FFFFFF;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 600;
}

#logoutButton:hover {
    background: #FF4A7D;
}

/* Scrollbar */
QScrollBar:vertical {
    border: none;
    background: #FFF5F8;
    width: 8px;
    margin: 0;
}

QScrollBar::handle:vertical {
    background: #FFB1C8;
    border-radius: 4px;
    min-height: 40px;
}

QScrollBar::handle:vertical:hover {
    background: #F06292;
}

QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {
    background: transparent;
}

QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
    height: 0px;
}

/* Horizontal scrollbar - hide it */
QScrollBar:horizontal {
    height: 0px;
    background: transparent;
}

/* Users Label */
#usersLabel {
    font-weight: 600;
    color: #7B61FF;
    padding: 10px;
}

/* Message Bubble */
#MessageBubble {
    margin: 6px 8px;
    min-width: 100px;
}

/* Avatar */
#avatarLabel {
    min-width: 40px;
    min-height: 40px;
    max-width: 40px;
    max-height: 40px;
}

/* Nickname */
#nicknameLabel {
    font-weight: 600;
    color: #7B61FF;
    padding: 2px 8px;
    margin: 0;
}

#nicknameLabel[own="true"] {
    text-align: right;
    color: #F06292;
}

/* Timestamp */
#timeLabel {
    color: #9C80FF;
    font-size: 11px;
    padding: 2px 8px;
    margin: 0;
}

#timeLabel[own="true"] {
    text-align: right;
}

/* Content */
#contentLabel {
    padding: 10px 12px;
    margin: 4px 8px;
    border-radius: 18px;
    white-space: pre-wrap;
    line-height: 1.5;
}

#contentLabel[own="true"] {
    background: qlineargradient(x1:0, y1:0, x2:1, y2:1, stop:0 #F06292, stop:1 #FF8AB1);
    color: #FFFFFF;
    border-top-right-radius: 4px;
}

#contentLabel[own="false"] {
    background: #E6E1FF;
    color: #7B61FF;
    border-top-left-radius: 4px;
}

#contentLabel:hover {
    opacity: 0.95;
}